<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Technical Introduction to OpenLCB</title>
        
        <meta name="robots" content="noindex" />
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div id="sidebar-scrollbox" class="sidebar-scrollbox">
                <ol class="chapter"><li class="expanded "><a href="intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="expanded "><a href="intro_node.html"><strong aria-hidden="true">1.1.</strong> Node</a></li><li class="expanded "><a href="intro_can.html"><strong aria-hidden="true">1.2.</strong> CAN</a></li><li class="expanded "><a href="intro_async_blink.html"><strong aria-hidden="true">1.3.</strong> Async Blink Initialization</a></li><li class="expanded "><a href="intro_ab_events.html"><strong aria-hidden="true">1.4.</strong> Async Blink Events</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Technical Introduction to OpenLCB</h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#introduction" id="introduction">Introduction</a></h1>
<h2><a class="header" href="#purpose" id="purpose">Purpose</a></h2>
<p>The purpose of this book is to help you get up to speed on OpenLCB so you can
start creating LCC products. There are a lot of concepts and we'll go into
just enough depth to get you going, without bogging you down with all the
details and possibilites. The standards and the techincal notes have a lot
more details.</p>
<h2><a class="header" href="#focus-of-this-book" id="focus-of-this-book">Focus of this book</a></h2>
<p>We're going to focus on how to create <em>node</em> that can be added to an
LCC bus. Therefore, we're going to focus on solutions that use the CAN
bus. There are other options, such as WiFi, but we won't cover them in
this book.</p>
<h2><a class="header" href="#assumptions" id="assumptions">Assumptions</a></h2>
<p>We're assuming you've used LCC products, and therefore already understand
concepts like the producer-consumer model. We also assume you've written
code for micro controllers and have worked with I/O pins.</p>
<h2><a class="header" href="#about-names" id="about-names">About Names</a></h2>
<p>Let's start with what to some might be confusing—the name LCC vs OpenLCB.
LCC is a brand name owned by the NMRA. It covers a set of standards that have
been adopted by the NMRA for Layout Command Control (hence the LCC).</p>
<p>OpenLCB is the name of the working group that created the standards approved by
the NMRA and continues to create new standards. This is a group of dedicated
volunteers who are working to fulfill the dream.</p>
<p>In this book, as in the standards, we'll use the term OpenLCB rather than LCC.</p>
<h1><a class="header" href="#node" id="node">Node</a></h1>
<p>A <em>Node</em> is the basic building block of an OpenLCB network. It's a device that can send and receive OpenLCB messages. We'll describe these messages in more detail in a later chapter.</p>
<p>Each node has a unique 6-byte ID that must be assigned by the manufactorer. We'll describe in a later chapter how you can get your own set of IDs to use in your products (or DIY boards).</p>
<h1><a class="header" href="#introduction-to-can" id="introduction-to-can">Introduction to CAN</a></h1>
<p>Controller Area Network (CAN) is a standard that was initially created in 1981 by Bosch, and has since been used for factory automation and communication networks in cars, to name just a few uses. Today there are hundreds of millions of nodes in daily use. </p>
<p>As a result, there are a number of relatively inexpensive ICs available that fully implement the CAN specifications out of the box. By using CAN controllers and drivers, you do not have to write highly time-sensitive code. Instead, you can focus on implementing support for the messages in the application layers, which is a &quot;relatively&quot; simple task compared with implementing a transport layer.</p>
<h2><a class="header" href="#can-messages" id="can-messages">CAN Messages</a></h2>
<p>CAN transmits messages, called <em>frames</em> on the bus. Every other device (node) on the bus can (and must) listen to all of the traffic on the bus. One of the interesting and useful aspects of CAN is how it handle collisions, which is through arbitration.</p>
<p>CAN frames, in the form used by OpenLCB, consist of a 29-bit header followed by zero or more bytes of data. This is using the <em>extended frame format</em>, also know as CAN 2.0 B.</p>
<p><img src="images/can_bits.jpg" alt="CAN Format" /></p>
<h3><a class="header" href="#arbitration" id="arbitration">Arbitration</a></h3>
<p>Arbitration is the process used to ensure that only one node will be transmitting data at one time, thus eliminating collisions and providing extremely reliable communications. It also allows nearly 100% utilization of the bandwidth for the bus.</p>
<p>The arbitration phase relies on drivers only driving the bus low, and never driving the bus high. If two nodes attempt to put different bit values on the bus at the same time, the 0 will always win. Here is a chart that shows how this works:</p>
<table><thead><tr><th>Node 1</th><th>Node 2</th><th>Bus Value</th></tr></thead><tbody>
<tr><td>0</td><td>0</td><td>0</td></tr>
<tr><td>0</td><td>1</td><td>0</td></tr>
<tr><td>1</td><td>0</td><td>0</td></tr>
<tr><td>1</td><td>1</td><td>0</td></tr>
</tbody></table>
<p>Arbitration uses the 29-bit header value as a priority value to gain access to the bus, where lower values have higher priority. This mechanism provides very high utilization of the bus’ bandwidth because one node will always win a collision and keep transmitting. In contrast, Ethernet uses a more complex scheme where nodes have to back off, wait a random period, then attempt to transmit again, thus wasting bandwidth.</p>
<p>For arbitration to work sucessfully, each message sent by a node needs to use a unique 29-bit ID. The details for this are handled by the OpenLCB specifications, and are different for different types of messages.</p>
<h1><a class="header" href="#example-messages" id="example-messages">Example Messages</a></h1>
<p><a href="https://github.com/bakerstu/openmrn">OpenMRN</a> is a C++ library that implements the entire OpenLCB stack with some OpenLCB extensions. The GIT repository hosting OpenMRN also contains some sample applications that can be run as desktop applications to join an OpenLCB network.</p>
<h2><a class="header" href="#async-blink" id="async-blink">Async Blink</a></h2>
<p>We won't go into details on how to build or run this application, as that is covered in the OpenMRN documentation. Instead, we'll use it to give you an idea of what actual messages look like.</p>
<p>The async_blink application can be run without a layout or a CAN OpenLCB network. You can run it entirely on a single computer.</p>
<p>The async_blink application sends an event every second, alternating between 0 and 1.</p>
<p>Here is the output from running the application under Linux:</p>
<p><img src="images/async_blink_output.png" alt="async_blink output" /></p>
<p>This probably looks a little overwhelming. Let's start with the message format. Each line is a seperate message sent or received on the OpenLCB network. In this case of OpemMRN and the async_blink application, we're using TCP/IP rather than CAN as the transport mechanism. The current code uses a text rather than binary for the messages, using a format based the GridConnect protocol:</p>
<pre><code>:X &lt;identifier&gt; &lt;N&gt; &lt;Data-0&gt;&lt;Data-1&gt;...&lt;Data-7&gt;;
</code></pre>
<p>As an example, the first message <code>:X17050415N;</code> has the ID <code>17050415</code> and no data. The ID and all other data are in HEX. </p>
<p>There are some log messages in the output that will help us get an idea of what's going on. However, these messages may not make a lot of sense without both understanding the application and a little more about the OpenLCB standards.</p>
<p>How do you map these messages back into the OpenLCB standards to understand what you're seeing?</p>
<h2><a class="header" href="#decoded-messages" id="decoded-messages">Decoded Messages</a></h2>
<p>JMRI displays decoded messages. So for this example we connected JMRI to the same TCP/IP OpenLCB bus (all running on the same computer). We'll cover how to use JMRI later. For now we're just going to focus on the messages being sent.</p>
<p><img src="images/alias_allocation_example.png" alt="Allocate Alias" /></p>
<p>You'll notice the first set of messages all say &quot;CID.&quot; This is a <em>Check ID</em> frame that is used as part of allocating an <em>alias</em> for the Node ID.</p>
<h2><a class="header" href="#node-aliases" id="node-aliases">Node Aliases</a></h2>
<p>The 29-bit headers for CAN messages need to be different for messages sent from different nodes to avoid collisions. The 6-byte Node ID is too long to fit into the header and leave room for more information. So instead, OpenLCB defines a 12-bit alias for Node IDs that are used in the header. By including the alias of the sender in most messages, we avoid collisions.</p>
<p>These aliases are negotiated between the nodes. The CID messages are part of this process. If you're interested in the details, you can find them in section 6 of the specifications (with more information in the technical note):</p>
<ul>
<li><a href="https://www.nmra.org/sites/default/files/standards/sandrp/OpenLCB/s-9.7.2.1-canframetransfer-2015-02-17.pdf">S-9.7.2.1 CAN Frame Transfer</a></li>
<li><a href="https://www.nmra.org/sites/default/files/standards/sandrp/OpenLCB/tn-9.7.2.1-canframetransfer-2016-02-06.pdf">TN-9.7.2.1 CAN Frame Transfer</a></li>
</ul>
<h3><a class="header" href="#check-id-cid" id="check-id-cid">Check ID (CID)</a></h3>
<p>There is one interesting detail here. The first four messages actually include the full node ID. The async_blink application has the following Node ID defined:</p>
<pre><code class="language-cpp">const openlcb::NodeID NODE_ID = 0x050101011410ULL;
</code></pre>
<p>If you divide this ID into four parts, you'll get <code>050</code>, <code>101</code>, <code>011</code>, and <code>410</code>. Now look at the first four messages:</p>
<pre><code>17050415
16101415
15011415
14410415
</code></pre>
<p>Look the &quot;middle&quot; hex values: 17<code>050</code>415, 16<code>101</code>415, 15<code>011</code>415, and 144<code>104</code>15. In other words, the full Node ID is present in these four messages. That's the case because each of these messages by itself might not be unique when sent from each node in a segment, but the four messages together will be. Why is this important?</p>
<p>These messages are basically saying that this node wants to use <code>415</code> as it's alias and is asking if anyone else is currently using that alias. In this example, there were no replies, which means this node is free to use this alias.</p>
<blockquote>
<p><strong>Note:</strong> The recommended algorithm for generating aliases in case there are collisions is based on a specific pseudo-random number generator that is dependent on the full Node ID.</p>
</blockquote>
<h3><a class="header" href="#reserve-id-rid" id="reserve-id-rid">Reserve ID (RID)</a></h3>
<p>The fifth message, <code>10700415</code>, is the Reserve ID (RID) frame. Since the node didn't get any arguments from other nodes, it's now declaring that it's reserved the alias <code>415</code>.</p>
<h3><a class="header" href="#alias-map-definition-amd" id="alias-map-definition-amd">Alias Map Definition (AMD)</a></h3>
<p>The sixth message reports the full Node ID associated with the alias that was just reserved:</p>
<pre><code>10701415 05 01 01 01 14 10
</code></pre>
<h3><a class="header" href="#initialize-complete" id="initialize-complete">Initialize Complete</a></h3>
<p>The messages above are part of the node's initialization phase. During this time it's not _&quot;<em>reachable</em> on the network. In other words, it won't respond events or messages addressed to it. Once it's negotiated a Node Alias, it sends out an Initialize Complete message telling anyone who cares that it's not online:</p>
<pre><code>19100415 05 01 01 01 14 10
</code></pre>
<p>This is documented in section 3.3.1 (with the CAD ID defined in 7.3.3.1):</p>
<ul>
<li><a href="https://www.nmra.org/sites/default/files/standards/sandrp/OpenLCB/s-9.7.3-messagenetwork-2016-02-06.pdf">S-9.7.3 Message Network</a></li>
</ul>
<h2><a class="header" href="#producerconsumer-events" id="producerconsumer-events">Producer/Consumer Events</a></h2>
<p>At this point there is another node that starts the Node Alias negotiation. You should be able to spot and read those messages now. We'll ignore them here.</p>
<p>Part of the required initialization process for a node is for it to publish the list of events that it produces and consumes. Doing so helps with gateways so that bridges can choose which events to send to other segments.</p>
<p>The next set of messages are this published information. The <code>async_blink</code> node supports two different events--one for 0 and the other for 1. It both produces and consumes these events, so it sends out four messages:</p>
<pre><code>19545415 05 02 01 02 02 00 00 00    Producer Identified Invalid
19544415 05 02 01 02 02 00 00 01    Producer Identified Valid

194C5415 05 02 01 02 02 00 00 00    Consumer Identified Invalid
194C4415 05 02 01 02 02 00 00 01    Consumer Identified Valid
</code></pre>
<p>The two event IDs are <code>05.02.01.02.02.00.00.00</code> and <code>05.02.01.02.02.00.00.01</code>.</p>
<p>We won't go into the details here. You can find more in the specifications and techinal notes:</p>
<ul>
<li><a href="https://www.nmra.org/sites/default/files/standards/sandrp/OpenLCB/s-9.7.3.1-eventtransport-2016-02-06.pdf">S-9.7.3.1 Event Transport</a> section 4.6</li>
<li><a href="https://www.nmra.org/sites/default/files/standards/sandrp/OpenLCB/tn-9.7.3.1-eventtransport-2016-02-06.pdf">TN-9.7.3.1 Event Transport</a></li>
</ul>
<h1><a class="header" href="#async-blink-events" id="async-blink-events">Async Blink Events</a></h1>
<h2><a class="header" href="#blink-events" id="blink-events">Blink Events</a></h2>
<p>Let's take a look at the OpenLCB trace again from JMRI:</p>
<p><img src="images/alias_allocation_example.png" alt="OpenLCB Trace" /></p>
<p>The last two messages are what we've buildig toward. These are the events that were sent by the <code>async_blink</code> node. It sends one of these events every second, alternating between the &quot;0&quot; and &quot;1&quot; events.</p>
<p>Let's take a closer look at the message itself, starting with the header:</p>
<pre><code>195b4415
</code></pre>
<p>The right three characters, <code>415</code>, are the Node ID alias that we talked about already. The middle two characters, <code>5b4</code>, you'll find listed in section 4.1 of <a href="https://www.nmra.org/sites/default/files/standards/sandrp/OpenLCB/s-9.7.3.1-eventtransport-2016-02-06.pdf">S-9.7.3.1</a> as the Producer/Consumer Event Report (PCER). The data for this message is the Event ID.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
